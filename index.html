<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Shaddai | Aromas & Deco</title>
    <link rel="icon" href="logo.icon">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Lato:wght@300;400;700&display=swap" rel="stylesheet">

    <style>
        /* ================= EXPLICACIÓN DE CSS Y VARIABLES ================= */
        
        :root {
            /* --bg-body: El color de fondo de toda la página.
               Usamos un lila muy pálido para que contraste con el violeta fuerte.
            */
            --bg-body: #fbf5ff; 

            /* --bg-card: Fondo blanco para las tarjetas de productos */
            --bg-card: #ffffff;

            /* --text: Color del texto general (Gris oscuro/Violeta oscuro) */
            --text: #2e0052;

            /* --border: Color de las líneas divisorias y bordes de inputs */
            --border: #e0ccff;

            /* --gold: COLOR PRIMARIO SOLICITADO (#8F00FF). 
               Se usa para iconos, textos destacados y detalles.
            */
            --gold: #8F00FF;

            /* --black: COLOR SECUNDARIO SOLICITADO (#7F00FF).
               Se usa para botones principales (Comprar, Guardar) para que resalten.
            */
            --black: #7F00FF;

            /* --mob-cols: Variable dinámica para cambiar entre 1 o 2 columnas en celular */
            --mob-cols: 1; 
        }

        /* body.dark-mode: Sobrescribe las variables cuando activas el modo oscuro.
           Invierte los colores a fondos oscuros y textos claros.
        */
        body.dark-mode {
            --bg-body: #12001b;
            --bg-card: #1f0a2e;
            --text: #e1bee7;
            --border: #4a0072;
            --black: #ffffff; /* Botones blancos en modo oscuro para leerse bien */
            --gold: #9d46ff;
        }

        /* * { box-sizing: border-box }: Hace que el padding no aumente el ancho total de los elementos */
        * { box-sizing: border-box; }

        body {
            margin: 0; padding: 0;
            font-family: 'Lato', sans-serif; /* Tipografía principal */
            background-color: var(--bg-body);
            color: var(--text);
            display: flex; /* Permite usar Flexbox para estructurar la página verticalmente */
            flex-direction: column; 
            min-height: 100vh; /* Asegura que la página mida al menos el 100% de la altura de la pantalla */
            overflow-x: hidden; /* Evita el scroll horizontal indeseado */
            transition: background 0.3s, color 0.3s; /* Suaviza el cambio de colores (ej. modo oscuro) */
        }

        /* PANTALLA DE BIENVENIDA */
        #welcome-overlay {
            position: fixed; /* Se queda fijo cubriendo toda la pantalla */
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: var(--bg-body);
            z-index: 999999; /* Asegura que esté encima de TODO */
            display: flex;
            flex-direction: column;
            align-items: center; /* Centra horizontalmente */
            justify-content: center; /* Centra verticalmente */
            transition: opacity 0.8s ease-out; /* Efecto de desvanecimiento al irse */
        }
        .welcome-logo {
            font-family: 'Cinzel', serif;
            font-size: 3rem;
            color: var(--black);
            margin-bottom: 10px;
            animation: fadeIn 1.5s ease; /* Aplica la animación definida abajo */
            text-align: center;
        }
        .welcome-logo span { color: var(--gold); } /* Pinta la palabra "Aromas" del otro color */

        /* Animaciones simples para la entrada */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* HEADER (Cabecera) */
        header {
            background: var(--bg-card);
            padding: 10px 15px;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(143, 0, 255, 0.15); /* Sombra violeta suave abajo del header */
            display: flex; flex-direction: column; gap: 8px;
            border-bottom: 1px solid var(--border);
        }

        .header-top { display: flex; justify-content: center; align-items: center; width: 100%; }
        .brand { font-family: 'Cinzel', serif; font-size: 1.6rem; font-weight: 700; color: var(--black); text-align: center; }
        .brand span { color: var(--gold); }

        /* BUSCADOR */
        .search-container { width: 100%; position: relative; }
        .search-input {
            width: 100%; padding: 8px 12px;
            border: 2px solid var(--border); /* Borde más grueso */
            background: var(--bg-body); color: var(--text);
            border-radius: 25px; /* Bordes redondeados */
            font-size: 0.9rem; outline: none; height: 35px;
        }
        .search-input:focus { border-color: var(--gold); } /* Cambia color al escribir */

        .autocomplete-box {
            position: absolute; top: 100%; left: 0; width: 100%;
            background: var(--bg-card); border: 1px solid var(--border);
            max-height: 200px; overflow-y: auto; z-index: 200;
        }
        .auto-item { padding: 10px; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 10px; cursor: pointer; color: var(--text); }
        .auto-item img { width: 30px; height: 30px; object-fit: cover; }

        /* MENU FLOTANTE PC (Burbujas a la derecha) */
        .floating-menu-pc {
            position: fixed; top: 50%; right: 0; transform: translateY(-50%);
            display: flex; flex-direction: column; gap: 10px; z-index: 900;
        }
        .float-btn {
            background: var(--gold); color: white; padding: 15px 12px;
            border-radius: 10px 0 0 10px; cursor: pointer;
            box-shadow: -2px 2px 10px rgba(0,0,0,0.2);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            position: relative; width: 50px;
            transition: 0.2s;
        }
        .float-btn:hover { width: 60px; } /* Efecto al pasar el mouse */
        .float-btn.nav-fav-active { background: #e74c3c; } /* Rojo si es Favoritos activo */
        .fc-badge { font-weight: bold; font-size: 0.8rem; margin-top: 2px; }

        /* BARRA DE CATEGORIAS (PC) */
        .nav-strip {
            display: flex; gap: 10px; padding: 10px 20px;
            overflow-x: auto; /* Permite scroll horizontal si no caben */
            background: var(--bg-card); white-space: nowrap;
            border-bottom: 1px solid var(--border);
        }
        .cat-btn {
            padding: 6px 15px; border: 1px solid var(--border);
            border-radius: 20px; cursor: pointer; background: var(--bg-body);
            color: var(--text); text-transform: capitalize; font-size: 0.9rem;
            transition: 0.2s;
        }
        .cat-btn.active { 
            background: var(--gold); /* Fondo activo violeta */
            color: white; 
            border-color: var(--gold); 
        }

        /* SELECTORES PARA MOVIL */
        .mob-cat-select-container {
            display: none; /* Oculto en PC */
            padding: 10px 20px;
            background: var(--bg-body);
            display: flex; align-items: center; gap: 10px;
        }

        .control-bar {
            padding: 10px 20px; display: flex; justify-content: flex-end; gap: 5px; background: var(--bg-body);
        }
        .sort-select { background: var(--bg-card); color: var(--text); border: 1px solid var(--border); padding: 5px; border-radius: 5px; width: 100%; }

        /* ESTRUCTURA PRINCIPAL (GRILLA DE PRODUCTOS) */
        .container { max-width: 1200px; margin: 0 auto; padding: 15px; flex: 1; width: 100%; }
        
        .grid {
            display: grid; 
            gap: 20px;
            /* Crea columnas automáticas. Mínimo 220px de ancho cada tarjeta */
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
        }

        /* DISEÑO DE LA TARJETA DEL PRODUCTO */
        .card {
            background: var(--bg-card); border: 1px solid var(--border);
            border-radius: 8px; overflow: hidden; /* Corta lo que sobresalga de los bordes redondeados */
            box-shadow: 0 4px 15px rgba(127, 0, 255, 0.08); /* Sombra suave violeta */
            display: flex; flex-direction: column; position: relative; transition: transform 0.2s;
        }
        .card:hover { transform: translateY(-5px); } /* Se levanta un poco al pasar el mouse */
        
        .card-img-area {
            overflow: hidden; cursor: pointer; position: relative;
            user-select: none; width: 100%;
        }
        .card-img-area img { 
            width: 100%; height: 100%; object-fit: cover; pointer-events: none; 
        }

        .card-heart {
            position: absolute; top: 10px; left: 10px; z-index: 20;
            background: rgba(255,255,255,0.9); width: 35px; height: 35px;
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            cursor: pointer; color: #ccc; transition: all 0.2s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2); font-size: 1.2rem;
        }
        .card-heart.liked { color: red; } /* Corazón rojo si está likeado */

        /* ETIQUETAS (Descuento, Destacado) */
        .badge-discount {
            position: absolute; top: 10px; right: 10px; background: #e74c3c; color: white;
            font-weight: bold; font-size: 0.8rem; padding: 4px 8px; border-radius: 4px; z-index: 10;
        }
        .badge-featured {
            position: absolute; bottom: 10px; left: 10px; background: var(--gold); color: white;
            font-weight: bold; font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; z-index: 10;
        }

        /* ESTILOS SIN STOCK */
        .card.sin-stock .card-img-area { filter: grayscale(1); } /* Pone la imagen en blanco y negro */
        .card.sin-stock .btn-buy { 
            pointer-events: none; opacity: 0.5; background: #999; cursor: not-allowed;
        }
        
        .stock-overlay {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(-15deg);
            background: rgba(0,0,0,0.8); color: white; font-size: 1.5rem; font-weight: bold;
            padding: 10px 20px; border: 2px solid white; z-index: 10; white-space: nowrap;
        }

        /* INFO DEL PRODUCTO */
        .card-info { padding: 15px; flex: 1; display: flex; flex-direction: column; }
        .card-title { font-weight: bold; font-size: 1.1rem; margin-bottom: 5px; color: var(--text); }
        
        .price-box { margin-bottom: 10px; }
        .old-price { text-decoration: line-through; color: #999; font-size: 0.9rem; margin-right: 5px; }
        .current-price { color: var(--gold); font-weight: 700; font-size: 1.2rem; }

        /* BOTONES DE LA TARJETA */
        .btn-buy { 
            background: var(--black); /* Violeta oscuro #7F00FF */
            color: white; border: none; padding: 10px; width: 100%; 
            cursor: pointer; font-weight: bold; border-radius: 4px; 
        }
        .btn-desc { 
            background: transparent; border: 1px solid var(--border); color: var(--text); 
            padding: 5px; width: 100%; margin-bottom: 5px; cursor: pointer; border-radius: 4px; 
        }

        /* RESPONSIVE (Móvil) */
        @media (max-width: 768px) {
            .grid { grid-template-columns: repeat(var(--mob-cols), 1fr); gap: 15px; } 
            .floating-menu-pc { display: none; } /* Ocultar menú de PC en móvil */
            .header-top { justify-content: center; }
            .card-img-area { height: 500px; } /* Imagen alta en móvil */
            .grid[style*="--mob-cols: 2"] .card-img-area { height: 250px; } /* Imagen normal si son 2 columnas */
            .nav-strip { display: none; }
            .mob-cat-select-container { display: flex; } /* Mostrar select en móvil */
        }

        @media (min-width: 769px) {
            .bottom-nav { display: none !important; } /* Ocultar barra inferior en PC */
            .mob-cat-select-container { display: none !important; }
            header { flex-direction: row; }
            .search-container { max-width: 400px; margin: 0 20px; }
            .card-img-area { height: 300px; }
        }

        footer { text-align: center; padding: 20px; background: var(--bg-card); color: var(--text); border-top: 1px solid var(--border); margin-top: auto; padding-bottom: 80px; }
        
        /* BARRA INFERIOR (Móvil) */
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; width: 100%; height: 60px;
            background: var(--bg-card); border-top: 1px solid var(--border);
            display: flex; justify-content: space-around; align-items: center;
            z-index: 900;
        }
        .bn-item { display: flex; flex-direction: column; align-items: center; font-size: 0.7rem; color: var(--text); gap: 3px; cursor: pointer; user-select: none; position: relative; }
        .bn-item i { font-size: 1.2rem; transition: color 0.2s; }
        .bn-item.nav-fav-active i { color: red; }
        
        .mob-badge {
            background: red; color: white; font-size: 0.65rem; font-weight: bold;
            width: 18px; height: 18px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            position: absolute; top: -5px; right: 5px;
        }

        /* VENTANAS MODALES (Popups) */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 5000; align-items: center; justify-content: center; }
        .modal-content { background: var(--bg-card); color: var(--text); padding: 20px; width: 90%; max-width: 700px; border-radius: 10px; max-height: 80vh; overflow-y: auto; }

        /* PANTALLA DE TIENDA CERRADA */
        #paused-screen { 
            position: fixed; top:0; left:0; width:100%; height:100%; 
            background: var(--bg-body); z-index:10000; display:none; 
            flex-direction:column; align-items:center; justify-content:center; 
            text-align:center; color: var(--text); 
        }
        #paused-screen h1 {
            font-family: 'Cinzel', serif;
            font-size: 3rem;
            color: var(--gold); /* Título violeta brillante */
            margin-bottom: 20px;
        }
        #paused-screen p {
            font-size: 1.5rem;
            color: var(--black);
            max-width: 80%;
            line-height: 1.6;
            background: rgba(127, 0, 255, 0.05); /* Fondo muy sutil */
            padding: 20px;
            border-radius: 10px;
            border: 1px dashed var(--border);
        }

        /* ACORDEON PARA EDITAR MENSAJE (BOTÓN DESPLEGABLE) */
        .accordion-btn {
            background-color: var(--bg-body);
            color: var(--text);
            cursor: pointer;
            padding: 15px;
            width: 100%;
            border: 1px solid var(--border);
            text-align: left;
            outline: none;
            font-size: 1rem;
            transition: 0.4s;
            border-radius: 5px;
            font-weight: bold;
            display: flex; justify-content: space-between; align-items: center;
        }
        .accordion-btn:hover { background-color: rgba(143, 0, 255, 0.1); }
        .accordion-content {
            padding: 0 15px;
            background-color: var(--bg-card);
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.2s ease-out;
            border: 1px solid var(--border);
            border-top: none;
            margin-bottom: 10px;
            border-radius: 0 0 5px 5px;
        }

        /* HERRAMIENTAS DE ADMIN */
        .admin-input { width: 100%; padding: 8px; margin-bottom: 10px; border: 1px solid var(--border); background: var(--bg-body); color: var(--text); }
        .tools-wrapper { display: flex; height: 400px; gap: 20px; }
        .tools-menu { width: 30%; border-right: 1px solid var(--border); display: flex; flex-direction: column; gap: 10px; }
        .tool-btn { text-align: left; padding: 10px; background: transparent; border: none; color: var(--text); cursor: pointer; font-weight: bold; border-radius: 5px; }
        .tool-btn.active { background: var(--gold); color: white; }
        .tools-content-box { width: 70%; overflow-y: auto; padding: 10px; }
        .tool-panel { display: none; }
        .tool-panel.active { display: block; }
        
        .trash-exit-btn { background: var(--gold); color: white; padding: 15px; width: 100%; text-align: center; font-weight: bold; cursor: pointer; margin-bottom: 20px; border-radius: 5px; display: none; }
        .trash-delete-all-btn { background: #e74c3c; color: white; padding: 10px; width: 100%; text-align: center; font-weight: bold; cursor: pointer; margin-bottom: 10px; border-radius: 5px; display: none; }

        /* MENU CONTEXTUAL (Click derecho) */
        #ctx-menu { display: none; position: fixed; background: var(--bg-card); border: 1px solid var(--border); box-shadow: 0 5px 15px rgba(0,0,0,0.2); z-index: 9999; width: 180px; border-radius: 5px; }
        .ctx-option { padding: 10px 15px; cursor: pointer; border-bottom: 1px solid var(--border); font-size: 0.9rem; color: var(--text); }
        .ctx-option:hover { background: rgba(143, 0, 255, 0.1); color: var(--gold); }
        .ctx-danger { color: #e74c3c; }

        .zoom-content { background: transparent; box-shadow: none; width: auto; max-width: 800px; display: flex; justify-content: center; overflow: hidden; position: relative; }
        .zoom-content img { max-width: 100%; max-height: 80vh; object-fit: contain; border-radius: 8px; background: white; padding: 5px; }
        .pagination { display: flex; justify-content: center; gap: 10px; margin-top: 30px; }
        .page-btn { width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; border: 1px solid var(--border); cursor: pointer; background: var(--bg-card); color: var(--text); }
        .page-btn.active { background: var(--black); color: var(--bg-body); }
    </style>
</head>
<body>

    <div id="welcome-overlay">
        <div class="welcome-logo">Shaddai <span>Aromas</span></div>
        <div class="welcome-sub">Bienvenido a nuestra tienda</div>
    </div>

    <div id="ctx-menu"></div>
    
    <div id="paused-screen">
        <h1>TIENDA CERRADA</h1>
        <p id="paused-text-display">Volvemos pronto.</p>
    </div>

    <div class="floating-menu-pc">
        <div class="float-btn" onclick="openCart()">
            <i class="fas fa-shopping-bag"></i>
            <span class="fc-badge" id="pc-cart-count">0</span>
        </div>
        <div class="float-btn" id="fav-btn-pc" onclick="toggleFavView()">
            <i class="fas fa-heart"></i>
        </div>
    </div>

    <header>
        <div class="header-top">
            <div class="brand">Shaddai <span>Aromas</span></div>
        </div>
        <div class="search-container">
            <input type="text" id="main-search" class="search-input" placeholder="Buscar producto..." oninput="handleSearch(this.value)">
            <div id="auto-box" class="autocomplete-box"></div>
        </div>
    </header>

    <div class="nav-strip" id="cat-container"></div>

    <div class="mob-cat-select-container">
        <span style="white-space:nowrap; font-weight:bold;">Categoría:</span>
        <select id="mob-cat-select" class="sort-select" onchange="setFilter(this.value, null)">
            </select>
    </div>

    <div class="control-bar">
        <div style="display:flex; align-items:center; gap:5px;">
            <span>Ordenar:</span>
            <select class="sort-select" onchange="setSort(this.value)">
                <option value="featured">Destacados</option>
                <option value="new">Más Nuevos</option>
                <option value="price-asc">Menor Precio</option>
                <option value="price-desc">Mayor Precio</option>
                <option value="sold">Más Vendidos</option>
            </select>
        </div>
    </div>

    <div class="container">
        <div id="trash-alert" class="trash-exit-btn" onclick="toggleTrash()">VOLVER A INICIO (SALIR DE PAPELERA)</div>
        <div id="trash-clean-btn" class="trash-delete-all-btn" onclick="emptyTrash()">VACIAR PAPELERA (TODO)</div>
        <div id="grid" class="grid"></div>
        <div id="pagination" class="pagination"></div>
    </div>

    <footer>
        <p>&copy; 2025 Shaddai Aromas</p>
    </footer>

    <div class="bottom-nav">
        <div class="bn-item" id="nav-home">
            <i class="fas fa-home"></i>
            <span>Inicio</span>
        </div>
        <div class="bn-item" onclick="openCart()">
            <i class="fas fa-shopping-cart"></i>
            <span>Carrito</span>
            <div id="mob-cart-count" class="mob-badge" style="display:none;">0</div>
        </div>
        <div class="bn-item" id="fav-btn-mob" onclick="toggleFavView()">
            <i class="fas fa-heart"></i>
            <span>Favoritos</span>
        </div>
        <div class="bn-item" onclick="window.open('https://wa.me/541131746665','_blank')">
            <i class="fab fa-whatsapp"></i>
            <span>Contacto</span>
        </div>
    </div>

    <div id="auth-modal" class="modal" onclick="if(event.target===this)closeModal('auth-modal')">
        <div class="modal-content" style="text-align:center;">
            <h3>Admin Login</h3>
            <button onclick="loginGoogle()" style="padding:10px 20px;">Ingresar con Google</button>
        </div>
    </div>

    <div id="tools-modal" class="modal" onclick="if(event.target===this)closeModal('tools-modal')">
        <div class="modal-content" style="max-width:800px;">
            <h3>Panel Admin</h3>
            <button id="btn-toggle-store" onclick="toggleMaintenance()" style="width:100%; padding:15px; background:var(--black); color:var(--bg-card); font-weight:bold; margin-bottom:10px;">CARGANDO...</button>
            
            <button class="accordion-btn" onclick="toggleAccordion('close-msg-panel')">
                Editar Mensaje de Cierre <i class="fas fa-chevron-down"></i>
            </button>
            <div id="close-msg-panel" class="accordion-content">
                <div style="padding:10px 0;">
                    <label>Mensaje para el cliente:</label>
                    <textarea id="paused-msg-input" class="admin-input" rows="3" placeholder="Escribe el mensaje de tienda cerrada..."></textarea>
                </div>
            </div>

            <div class="tools-wrapper" style="margin-top:10px;">
                <div class="tools-menu">
                    <button class="tool-btn active" onclick="switchToolTab('t-view', this)">Vista</button>
                    <button class="tool-btn" onclick="switchToolTab('t-price', this)">Precios</button>
                    <button class="tool-btn" onclick="switchToolTab('t-cats', this)">Categorías</button>
                </div>
                
                <div class="tools-content-box">
                    <div id="t-view" class="tool-panel active">
                        <button onclick="toggleGlobalDarkMode()" style="width:100%; padding:10px; margin-bottom:5px; background:#555; color:white;">Alternar Modo Oscuro</button>
                        <button onclick="toggleMobileCols()" style="width:100%; padding:10px; background:var(--gold); color:white;">Vista Móvil (1 o 2 Cols)</button>
                    </div>

                    <div id="t-price" class="tool-panel">
                        <label>Descuento (%):</label>
                        <div style="display:flex; gap:5px; margin-bottom:10px;">
                            <input type="number" id="global-disc-val" class="admin-input" placeholder="%">
                            <button onclick="applyGlobalDiscount()" style="background:var(--gold); color:white; border:none;">Aplicar</button>
                            <button onclick="removeGlobalDiscount()" style="background:red; color:white; border:none;">Quitar</button>
                        </div>
                        <label>Inflación (%):</label>
                        <div style="display:flex; gap:5px;">
                            <input type="number" id="global-inf-val" class="admin-input" placeholder="%">
                            <button onclick="applyGlobalInflation()" style="background:var(--black); color:white; border:none;">Actualizar</button>
                        </div>
                    </div>

                    <div id="t-cats" class="tool-panel">
                        <label>Categorías Visibles (separadas por coma):</label>
                        <input type="text" id="cats-config" class="admin-input" placeholder="Ej: Perfumes,Velas,Ofertas">
                    </div>
                </div>
            </div>

            <button onclick="saveGlobalConfig()" style="width:100%; padding:15px; background:var(--gold); color:white; font-weight:bold; margin-top:10px;">GUARDAR GENERAL</button>
        </div>
    </div>

    <div id="form-modal" class="modal" onclick="if(event.target===this)safeCloseForm()">
        <div class="modal-content">
            <h3>Editar Producto</h3>
            <input type="hidden" id="p-id">
            <label>Nombre:</label> <input type="text" id="p-name" class="admin-input">
            <label>Precio:</label> <input type="number" id="p-price" class="admin-input">
            
            <label>Categoría:</label>
            <input type="text" id="p-cat" class="admin-input" list="cat-list">
            <datalist id="cat-list"></datalist>

            <label>Subir Imagen (Galería):</label>
            <input type="file" id="p-file" class="admin-input" accept="image/*">
            <label>O URL de Imagen:</label> 
            <input type="text" id="p-img" class="admin-input" placeholder="https://...">
            
            <label>Descripción:</label> <textarea id="p-desc" class="admin-input"></textarea>
            
            <div style="display:flex; align-items:center; gap:10px; margin-bottom:10px; background:rgba(0,0,0,0.05); padding:10px;">
                <input type="checkbox" id="p-featured" style="width:20px; height:20px;">
                <label for="p-featured" style="font-weight:bold; color:var(--gold);">DESTACADO (Arriba de todo)</label>
            </div>

            <label>Vendidos:</label> <input type="number" id="p-sold" class="admin-input" value="0">
            <button id="btn-save-prod" onclick="saveProduct()" style="width:100%; background:var(--black); color:var(--bg-card); padding:10px; border:none;">GUARDAR</button>
        </div>
    </div>

    <div id="desc-modal" class="modal" onclick="if(event.target===this)closeModal('desc-modal')">
        <div class="modal-content">
            <h3 id="d-title" style="color:var(--gold);"></h3>
            <p id="d-text" style="line-height:1.6;"></p>
        </div>
    </div>

    <div id="zoom-modal" class="modal" onclick="closeModal('zoom-modal')">
        <div class="zoom-content" onclick="event.stopPropagation()">
            <img id="zoom-img" src="" onclick="closeModal('zoom-modal')">
        </div>
    </div>

    <div id="cart-modal" class="modal" onclick="if(event.target===this)closeModal('cart-modal')">
        <div class="modal-content">
            <h3>Tu Carrito</h3>
            <div id="cart-list"></div>
            <h3>Total: $<span id="cart-total">0</span></h3>
            <button onclick="checkout()" style="width:100%; background:var(--gold); color:white; padding:15px; border:none; font-weight:bold;">PEDIR POR WHATSAPP</button>
        </div>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, getDoc, doc, updateDoc, deleteDoc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const app = initializeApp({
        apiKey: "AIzaSyCtqvadYYEIq_i44sA34A6JPArTL6lV5yw",
        authDomain: "shaddai-da8d6.firebaseapp.com",
        projectId: "shaddai-da8d6",
        storageBucket: "shaddai-da8d6.firebasestorage.app",
        messagingSenderId: "1013701150678",
        appId: "1:1013701150678:web:2a37d362183e11dbacc677"
    });
    const auth = getAuth(app);
    const db = getFirestore(app);

    let products = [];
    let cart = JSON.parse(localStorage.getItem('cart')) || []; 
    let favorites = JSON.parse(localStorage.getItem('favs')) || [];
    let isAdmin = false;
    
    // Configuración por defecto incluyendo mensaje de pausa
    let tempConfig = { paused: false, pausedMessage: "Volvemos pronto.", darkMode: false, mobileCols: 1, categories: "Perfumes,Velas,Decoración" };
    let currentConfig = { ...tempConfig }; 
    
    let currentPage = 1;
    let currentFilter = 'all';
    let currentSort = 'featured'; 
    let trashMode = false;
    let favMode = false;
    let searchQ = "";

    const isMobile = window.innerWidth <= 768;
    const itemsPerPage = isMobile ? 6 : 20;

    window.addEventListener('load', () => {
        setupKeys();
        setupMobileLogin();
        updateCartUI();
        
        setTimeout(() => {
            const screen = document.getElementById('welcome-overlay');
            screen.style.opacity = '0';
            setTimeout(() => screen.style.display = 'none', 800);
        }, 2000);
    });

    // DATA
    onSnapshot(collection(db, "productos"), (snap) => {
        products = [];
        snap.forEach(d => products.push({id: d.id, ...d.data()}));
        render();
    });

    onSnapshot(doc(db, "config", "main"), (snap) => {
        if(snap.exists()) {
            currentConfig = { ...currentConfig, ...snap.data() };
            tempConfig = { ...currentConfig }; 
            applyVisualConfig();
        }
    });

    function applyVisualConfig() {
        updateStoreBtn();
        if(currentConfig.darkMode) document.body.classList.add('dark-mode'); else document.body.classList.remove('dark-mode');
        document.documentElement.style.setProperty('--mob-cols', currentConfig.mobileCols || 1);
        document.getElementById('cats-config').value = currentConfig.categories;
        
        // Cargar mensaje guardado
        document.getElementById('paused-msg-input').value = currentConfig.pausedMessage || "Volvemos pronto.";
        document.getElementById('paused-text-display').innerText = currentConfig.pausedMessage || "Volvemos pronto.";

        renderCategories();
        if(currentConfig.paused && !isAdmin) document.getElementById('paused-screen').style.display = 'flex';
        else document.getElementById('paused-screen').style.display = 'none';
    }

    onAuthStateChanged(auth, u => {
        isAdmin = !!u;
        if(isAdmin) document.getElementById('paused-screen').style.display = 'none';
        render();
    });

    function updateStoreBtn() {
        const btn = document.getElementById('btn-toggle-store');
        if(currentConfig.paused) { btn.innerText = "ABRIR TIENDA (Está Cerrada)"; btn.style.background = "var(--gold)"; } 
        else { btn.innerText = "CERRAR TIENDA (Está Abierta)"; btn.style.background = "var(--black)"; }
    }

    function renderCategories() {
        const cats = currentConfig.categories.split(',').map(c=>c.trim());
        const divPC = document.getElementById('cat-container');
        const selectMob = document.getElementById('mob-cat-select');
        
        divPC.innerHTML = `<button class="cat-btn ${currentFilter==='all'?'active':''}" onclick="setFilter('all', this)">Todo</button>`;
        selectMob.innerHTML = `<option value="all">Todo</option>`;

        cats.forEach(c => {
            if(c) {
                divPC.innerHTML += `<button class="cat-btn ${currentFilter===c?'active':''}" onclick="setFilter('${c}', this)">${c}</button>`;
                selectMob.innerHTML += `<option value="${c}">${c}</option>`;
            }
        });
        selectMob.value = currentFilter;
    }

    function render() {
        document.getElementById('trash-alert').style.display = trashMode ? 'block' : 'none';
        document.getElementById('trash-clean-btn').style.display = trashMode ? 'block' : 'none';
        
        let list = products.filter(p => trashMode ? p.deleted : !p.deleted);
        
        if(favMode) list = list.filter(p => favorites.includes(p.id));
        if(currentFilter !== 'all') list = list.filter(p => p.categoria === currentFilter);
        if(searchQ.length > 0) list = list.filter(p => p.nombre.toLowerCase().includes(searchQ.toLowerCase()));

        list.sort((a,b) => {
            if(currentSort === 'featured' || currentSort === 'new') {
                if (a.featured && !b.featured) return -1;
                if (!a.featured && b.featured) return 1;
            }
            if(currentSort === 'price-asc') return getPrice(a) - getPrice(b);
            if(currentSort === 'price-desc') return getPrice(b) - getPrice(a);
            if(currentSort === 'sold') return (b.soldCount||0) - (a.soldCount||0);
            return 0; 
        });

        const pages = Math.ceil(list.length / itemsPerPage);
        if(currentPage > pages) currentPage = 1;
        const start = (currentPage - 1) * itemsPerPage;
        const view = list.slice(start, start + itemsPerPage);

        const grid = document.getElementById('grid');
        grid.innerHTML = "";

        view.forEach(p => {
            const noStock = p.stock === false;
            const finalPrice = getPrice(p);
            const hasDisc = p.discount > 0;
            const isFav = favorites.includes(p.id);
            
            const el = document.createElement('div');
            el.className = `card ${noStock ? 'sin-stock' : ''}`;
            
            if(isAdmin) {
                el.oncontextmenu = (e) => { e.preventDefault(); showAdminMenu(e.clientX, e.clientY, p); };
                let timer;
                const imgArea = document.createElement('div'); 
                imgArea.className = 'card-img-area';
                imgArea.innerHTML = `
                    <img src="${p.image}"> 
                    ${noStock ? '<div class="stock-overlay">SIN STOCK</div>' : ''}
                    ${hasDisc ? `<div class="badge-discount">-${p.discount}%</div>` : ''}
                    ${p.featured ? `<div class="badge-featured">DESTACADO</div>` : ''}
                    <div class="card-heart ${isFav?'liked':''}" onclick="event.stopPropagation(); toggleHeart('${p.id}')"><i class="fas fa-heart"></i></div>
                `;
                imgArea.addEventListener('touchstart', (e) => { 
                    timer = setTimeout(() => { showAdminMenu(e.touches[0].clientX, e.touches[0].clientY, p); }, 800); 
                });
                imgArea.addEventListener('touchend', () => clearTimeout(timer));
                imgArea.addEventListener('click', () => openZoom(p.image)); 
                el.appendChild(imgArea);
            } else {
                const imgArea = document.createElement('div');
                imgArea.className = 'card-img-area';
                imgArea.innerHTML = `
                    <img src="${p.image}">
                    ${noStock ? '<div class="stock-overlay">SIN STOCK</div>' : ''}
                    ${hasDisc ? `<div class="badge-discount">-${p.discount}%</div>` : ''}
                    ${p.featured ? `<div class="badge-featured">DESTACADO</div>` : ''}
                    <div class="card-heart ${isFav?'liked':''}" onclick="event.stopPropagation(); toggleHeart('${p.id}')"><i class="fas fa-heart"></i></div>
                `;
                imgArea.onclick = () => openZoom(p.image);
                el.appendChild(imgArea);
            }
            
            let priceHtml = `<div class="current-price">$${finalPrice}</div>`;
            if(hasDisc) {
                priceHtml = `<div class="price-box"><span class="old-price">$${p.precio}</span> <span class="current-price">$${finalPrice}</span></div>`;
            } else {
                priceHtml = `<div class="price-box"><span class="current-price">$${finalPrice}</span></div>`;
            }

            const info = document.createElement('div');
            info.className = 'card-info';
            info.innerHTML = `
                <div class="card-title">${p.nombre}</div>
                ${priceHtml}
                <button class="btn-desc" onclick="openDesc('${p.id}')">Ver Descripción</button>
                <button class="btn-buy" id="add-btn-${p.id}" onclick="addToCart('${p.id}')">AGREGAR</button>
            `;
            el.appendChild(info);
            grid.appendChild(el);
        });

        const pag = document.getElementById('pagination');
        pag.innerHTML = "";
        for(let i=1; i<=pages; i++) pag.innerHTML += `<div class="page-btn ${i===currentPage?'active':''}" onclick="setPage(${i})">${i}</div>`;
    }

    function getPrice(p) { return p.discount > 0 ? Math.round(p.precio * (1 - p.discount/100)) : p.precio; }

    function showAdminMenu(x, y, p) {
        const m = document.getElementById('ctx-menu');
        if (p.deleted) {
            m.innerHTML = `
                <div class="ctx-option" onclick="trashProd('${p.id}', false)">Restaurar</div>
                <div class="ctx-option ctx-danger" onclick="permDelete('${p.id}')">Borrar Permanente</div>
            `;
        } else {
            m.innerHTML = `
                <div class="ctx-option" onclick="editProd('${p.id}')">Editar</div>
                <div class="ctx-option" onclick="toggleStock('${p.id}', ${!p.stock})">${p.stock===false?'Poner Stock':'Sin Stock'}</div>
                <div class="ctx-option ctx-danger" onclick="trashProd('${p.id}', true)">Papelera</div>
            `;
        }
        m.style.display = 'block'; m.style.top = y+'px'; m.style.left = x+'px';
    }

    window.toggleHeart = (id) => {
        if(favorites.includes(id)) favorites = favorites.filter(f=>f!==id);
        else favorites.push(id);
        localStorage.setItem('favs', JSON.stringify(favorites));
        render();
    }
    window.toggleFavView = () => {
        favMode = !favMode;
        trashMode = false;
        const pcBtn = document.getElementById('fav-btn-pc');
        const mobBtn = document.getElementById('fav-btn-mob');
        if(favMode) { pcBtn.classList.add('nav-fav-active'); mobBtn.classList.add('nav-fav-active'); } 
        else { pcBtn.classList.remove('nav-fav-active'); mobBtn.classList.remove('nav-fav-active'); }
        render();
    }

    window.addToCart = (id) => {
        const p = products.find(x => x.id === id);
        const existing = cart.find(x => x.id === id);
        if(existing) existing.qty = (existing.qty || 1) + 1;
        else cart.push({...p, qty: 1});
        saveCart();
    };

    window.toggleMaintenance = () => { tempConfig.paused = !tempConfig.paused; alert("Cambio pendiente. Toca GUARDAR GENERAL."); };
    window.toggleGlobalDarkMode = () => { tempConfig.darkMode = !tempConfig.darkMode; alert("Cambio pendiente. Toca GUARDAR GENERAL."); };
    window.toggleMobileCols = () => { tempConfig.mobileCols = (tempConfig.mobileCols === 1) ? 2 : 1; alert("Cambio pendiente. Toca GUARDAR GENERAL."); };
    
    // FUNCION PARA DESPLEGAR ACORDEON
    window.toggleAccordion = (id) => {
        const panel = document.getElementById(id);
        if (panel.style.maxHeight){
            panel.style.maxHeight = null;
        } else {
            panel.style.maxHeight = panel.scrollHeight + "px";
        }
    };

    window.saveGlobalConfig = async () => {
        tempConfig.categories = document.getElementById('cats-config').value;
        tempConfig.pausedMessage = document.getElementById('paused-msg-input').value; // Guardar mensaje
        await setDoc(doc(db, "config", "main"), tempConfig);
        alert("Configuración Guardada!");
    };

    window.switchToolTab = (id, btn) => {
        document.querySelectorAll('.tool-panel').forEach(p=>p.classList.remove('active'));
        document.querySelectorAll('.tool-btn').forEach(b=>b.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        btn.classList.add('active');
    }

    window.handleSearch = (val) => {
        searchQ = val;
        const box = document.getElementById('auto-box');
        box.innerHTML = "";
        if(val.length > 0) {
            const res = products.filter(p => !p.deleted && p.nombre.toLowerCase().includes(val.toLowerCase())).slice(0,5);
            res.forEach(p => {
                const d = document.createElement('div');
                d.className = 'auto-item';
                d.innerHTML = `<img src="${p.image}"> ${p.nombre}`;
                d.onclick = () => { document.getElementById('main-search').value = p.nombre; searchQ = p.nombre; box.innerHTML = ""; render(); };
                box.appendChild(d);
            });
        }
        render();
    }

    function setupKeys() {
        document.addEventListener('keydown', e => {
            if(e.altKey && e.key.toLowerCase() === 'n') document.getElementById('auth-modal').style.display='flex';
            if(e.altKey && e.key.toLowerCase() === 'l' && isAdmin) document.getElementById('tools-modal').style.display='flex';
        });
    }
    function setupMobileLogin() {
        const btn = document.getElementById('nav-home');
        let timer;
        const start = () => timer = setTimeout(() => document.getElementById('auth-modal').style.display='flex', 5000);
        const end = () => clearTimeout(timer);
        btn.addEventListener('touchstart', start); btn.addEventListener('touchend', end);
        btn.addEventListener('mousedown', start); btn.addEventListener('mouseup', end);
        btn.addEventListener('click', () => { window.scrollTo(0,0); setFilter('all', document.querySelector('.cat-btn')); });
    }

    window.addEventListener('contextmenu', e => {
        if(!isAdmin) return;
        if(!e.target.closest('.card')) {
            e.preventDefault();
            const m = document.getElementById('ctx-menu');
            m.innerHTML = `
                <div class="ctx-option" onclick="openForm()">Nuevo Producto</div>
                <div class="ctx-option" onclick="toggleTrash()">Ver ${trashMode?'Tienda':'Papelera'}</div>
                <div class="ctx-option" onclick="document.getElementById('tools-modal').style.display='flex'">Herramientas</div>
            `;
            m.style.display = 'block'; m.style.top = e.clientY+'px'; m.style.left = e.clientX+'px';
        }
    });
    window.addEventListener('click', () => { 
        document.getElementById('ctx-menu').style.display='none'; 
        document.getElementById('auto-box').innerHTML=""; 
    });

    window.loginGoogle = async () => { try{await signInWithPopup(auth,new GoogleAuthProvider());closeModal('auth-modal')}catch(e){alert(e.message)} };
    window.setFilter = (c,b) => { currentFilter=c; currentPage=1; renderCategories(); render(); };
    window.setSort = (v) => { currentSort=v; render(); };
    window.setPage = (p) => { currentPage=p; render(); window.scrollTo(0,0); };
    window.closeModal = (id) => document.getElementById(id).style.display='none';
    
    window.safeCloseForm = () => {
        if(confirm("¿Seguro que quieres salir sin guardar?")) document.getElementById('form-modal').style.display='none';
    };

    window.openZoom = (src) => { document.getElementById('zoom-img').src=src; document.getElementById('zoom-modal').style.display='flex'; };
    window.openDesc = (id) => { const p=products.find(x=>x.id===id); document.getElementById('d-title').innerText=p.nombre; document.getElementById('d-text').innerText=p.descripcion||""; document.getElementById('desc-modal').style.display='flex'; };

    window.changeQty = (id, change) => {
        const idx = cart.findIndex(x => x.id === id);
        if(idx > -1) {
            cart[idx].qty += change;
            if(cart[idx].qty <= 0) cart.splice(idx, 1);
            saveCart();
            window.openCart(); 
        }
    };

    function saveCart() { localStorage.setItem('cart', JSON.stringify(cart)); updateCartUI(); }

    window.openCart = () => {
        const l=document.getElementById('cart-list'); l.innerHTML=""; let t=0;
        if(cart.length === 0) l.innerHTML = "<p>Carrito vacío.</p>";
        cart.forEach((p)=>{ 
            const pr = getPrice(p) * p.qty; t+=pr; 
            l.innerHTML += `
            <div class="cart-row">
                <div style="flex:1"><b>${p.nombre}</b><br><small>$${getPrice(p)} u.</small></div>
                <div class="cart-qty-ctrl">
                    <div class="c-btn" onclick="changeQty('${p.id}', -1)">-</div>
                    <span>${p.qty}</span>
                    <div class="c-btn" onclick="changeQty('${p.id}', 1)">+</div>
                </div>
            </div>`; 
        });
        document.getElementById('cart-total').innerText=t; 
        document.getElementById('cart-modal').style.display='flex';
    };

    window.checkout = () => { 
        let m="Hola! Pedido:%0A",t=0; 
        cart.forEach(p=>{const pr=getPrice(p)*p.qty;t+=pr;m+=`- ${p.nombre} (x${p.qty}) $${pr}%0A`}); 
        m+=`Total: $${t}`; 
        window.open(`https://wa.me/541131746665?text=${m}`,'_blank'); 
    };
    
    function updateCartUI() {
        const count = cart.reduce((acc, item) => acc + (item.qty || 1), 0);
        document.getElementById('pc-cart-count').innerText=count;
        document.getElementById('mob-cart-count').innerText=count;
        document.getElementById('mob-cart-count').style.display=count?'flex':'none';
    }
    
    window.applyGlobalDiscount = () => { const v=Number(document.getElementById('global-disc-val').value); if(confirm("Aplicar?")) products.forEach(p=>updateDoc(doc(db,"productos",p.id),{discount:v})); };
    window.removeGlobalDiscount = () => { if(confirm("Quitar?")) products.forEach(p=>updateDoc(doc(db,"productos",p.id),{discount:0})); };
    window.applyGlobalInflation = () => { const v=Number(document.getElementById('global-inf-val').value); if(confirm("Aplicar precios?")) products.forEach(p=>updateDoc(doc(db,"productos",p.id),{precio:Math.round(p.precio*(1+v/100))})); };
    window.editProd = (id) => window.openForm(id);
    
    window.openForm = (id) => { 
        const dl = document.getElementById('cat-list'); dl.innerHTML = "";
        currentConfig.categories.split(',').forEach(c => {
            const opt = document.createElement('option'); opt.value = c.trim(); dl.appendChild(opt);
        });

        if(id){ const p=products.find(x=>x.id===id); document.getElementById('p-id').value=id; document.getElementById('p-name').value=p.nombre; document.getElementById('p-price').value=p.precio; document.getElementById('p-cat').value=p.categoria; document.getElementById('p-img').value=p.image; document.getElementById('p-desc').value=p.descripcion||""; document.getElementById('p-sold').value=p.soldCount||0; document.getElementById('p-featured').checked = p.featured||false; }
        else { document.querySelectorAll('#form-modal input').forEach(i=>i.value=""); document.getElementById('p-featured').checked = false; }
        document.getElementById('form-modal').style.display='flex';
    };
    
    function compressImageForFirestore(file, callback) {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = (event) => {
            const img = new Image();
            img.src = event.target.result;
            img.onload = () => {
                const canvas = document.createElement('canvas');
                let width = img.width;
                let height = img.height;
                const maxWidth = 800; 
                if (width > maxWidth) {
                    height *= maxWidth / width;
                    width = maxWidth;
                }
                canvas.width = width;
                canvas.height = height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, width, height);
                const compressedDataUrl = canvas.toDataURL('image/jpeg', 0.6);
                callback(compressedDataUrl);
            };
        };
    }

    window.saveProduct = async () => {
        const btn = document.getElementById('btn-save-prod');
        btn.innerText = "GUARDANDO... (ESPERA)";
        btn.disabled = true;

        const id=document.getElementById('p-id').value;
        const file = document.getElementById('p-file').files[0];
        const name = document.getElementById('p-name').value;
        const price = Number(document.getElementById('p-price').value);
        const cat = document.getElementById('p-cat').value;
        const imgUrlInput = document.getElementById('p-img').value;
        const desc = document.getElementById('p-desc').value;
        const sold = Number(document.getElementById('p-sold').value);
        const feat = document.getElementById('p-featured').checked;

        const saveData = async (imgFinal) => {
            try {
                const d = { nombre: name, precio: price, categoria: cat, image: imgFinal, descripcion: desc, soldCount: sold, featured: feat, stock: true, deleted: false };
                if(id) {
                    await updateDoc(doc(db,"productos",id),d);
                    document.getElementById('form-modal').style.display='none'; 
                } else {
                    await addDoc(collection(db,"productos"),d);
                    document.getElementById('p-name').value = "";
                    document.getElementById('p-price').value = "";
                    document.getElementById('p-img').value = "";
                    document.getElementById('p-desc').value = "";
                    document.getElementById('p-file').value = "";
                    document.getElementById('p-featured').checked = false;
                    alert("¡PRODUCTO CREADO EXITOSAMENTE!");
                }
            } catch (error) {
                console.error(error);
                alert("Hubo un error al guardar. Puede que la imagen siga siendo muy pesada.");
            } finally {
                btn.innerText = "GUARDAR";
                btn.disabled = false;
            }
        };

        if (file) {
            if (file.size > 300 * 1024) {
                alert("IMAGEN PESADA: Se está optimizando automáticamente para que no desaparezca. Espera un momento...");
                compressImageForFirestore(file, (compressedImgBase64) => {
                    saveData(compressedImgBase64);
                });
            } else {
                const reader = new FileReader();
                reader.onload = (e) => saveData(e.target.result);
                reader.readAsDataURL(file);
            }
        } else {
            saveData(imgUrlInput);
        }
    };

    window.trashProd = async(id,s) => await updateDoc(doc(db,"productos",id),{deleted:s});
    window.permDelete = async(id) => {
        if(confirm("¿ESTÁS SEGURO? Se borrará para siempre.")) {
            await deleteDoc(doc(db, "productos", id));
        }
    };
    window.emptyTrash = async() => {
        if(confirm("¿BORRAR TODOS LOS PRODUCTOS DE LA PAPELERA?")) {
            const toDelete = products.filter(p => p.deleted);
            toDelete.forEach(async p => await deleteDoc(doc(db, "productos", p.id)));
        }
    };

    window.toggleStock = async(id,s) => await updateDoc(doc(db,"productos",id),{stock:s});
    window.toggleTrash = () => { trashMode=!trashMode; favMode=false; render(); };
</script>
</body>
</html>
